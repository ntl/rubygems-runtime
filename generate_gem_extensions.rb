#!/usr/bin/env ruby

require 'rubygems'

require_relative 'load_path'
require 'bundler/setup'

require 'pry'

File.open('lib/rubygems/runtime/gem_extensions/generated.rb', 'w') do |rb|
  rb.puts <<~RUBY
  # Generated by #{$PROGRAM_NAME}
  module Rubygems
    module Runtime
      module GemExtensions
        @@win_platform = nil

        WIN_PATTERNS = #{Gem::WIN_PATTERNS.inspect}

  RUBY

  platform_predicate_methods = Gem.methods.grep(/_platform\?$/)

  [
    :ruby_api_version,
    :extension_api_version,
    :default_dir,
    :location_of_caller,
    *platform_predicate_methods
  ].each_with_index do |method_name, index|
    method = Gem.method(method_name)

    unmodified_source = method.source

    modified_source = unmodified_source.
      sub('def self.', 'def ').
      gsub(/^/, '    ')

    if index > 0
      rb.puts
      end

    rb.puts modified_source
  end

  rb.puts <<~RUBY
      end
    end
  end
  RUBY
end
